<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agregar Denuncia - RRHH</title>
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>
<header>
    <p>SISTEMA DE RRHH</p>
    <nav>
        <a href="empleados.html">Gestión Empleados</a>
        <a href="denuncias.html">Denuncias</a>
        <div class="logout">
            <button class="btn btn-red">Cerrar Sesión</button>
        </div>
    </nav>
</header>

<main>
    <div class="form-container">

        <div id="mensaje-feedback" style="display: none;"></div>

        <h2>Agregar Denuncia</h2>
        <form id="denunciaForm">
            <label for="puestos">Puesto</label>
            <select id="puestos" required>
                <option value="" disabled selected>--Seleccione--</option>
            </select>

            <label for="empleadoId">ID del Empleado</label>
            <input type="number" id="empleadoId" required placeholder="Ingresa el ID">

            <label for="nombre">Nombre</label>
            <input type="text" id="nombre" readonly>
            <label for="apellido">Apellido</label>
            <input type="text" id="apellido" readonly>
            <label for="email">Email</label>
            <input type="email" id="email" readonly>

            <div class="form-group">
                <label for="motivo">Motivo:</label>
                <textarea id="motivo" required></textarea>
            </div>

            <div class="form-actions">
                <button type="submit" class="btn">Guardar</button>
                <a href="denuncias.html" class="btn btn-red">Cancelar</a>
            </div>
        </form>
    </div>
</main>

<footer>
    <p>Todos los Derechos Reservados 2025 &copy;</p>
</footer>

<script>
    const puestosSelect = document.getElementById("puestos");
    const empleadoIdInput = document.getElementById("empleadoId");
    const nombreInput = document.getElementById("nombre");
    const apellidoInput = document.getElementById("apellido");
    const emailInput = document.getElementById("email");
    const motivoInput = document.getElementById("motivo");
    const form = document.getElementById("denunciaForm");

    // --- NUEVO: Referencia al div de mensajes ---
    const mensajeDiv = document.getElementById("mensaje-feedback");

    // --- NUEVO: Función para mostrar mensajes ---
    // (Usando estilos en línea para no depender de CSS)
    function mostrarMensaje(texto, tipo = "error") {
        mensajeDiv.textContent = texto;
        mensajeDiv.style.color = (tipo === "exito") ? "green" : "red";
        mensajeDiv.style.border = (tipo === "exito") ? "1px solid green" : "1px solid red";
        mensajeDiv.style.padding = "10px";
        mensajeDiv.style.marginBottom = "15px";
        mensajeDiv.style.borderRadius = "5px";
        mensajeDiv.style.display = "block";
    }

    // Traer puestos desde el backend
    async function fetchPuestos() {
        try {
            const res = await fetch("http://localhost:8080/api/puestos");
            const puestos = await res.json();
            puestos.forEach(p => {
                const option = document.createElement("option");
                option.value = p.id;
                option.textContent = p.nombre;
                puestosSelect.appendChild(option);
            });
        } catch (error) {
            console.error("Error cargando puestos:", error);
            // --- CAMBIO: Mostrar error ---
            mostrarMensaje("Error al cargar la lista de puestos.", "error");
        }
    }

    // Traer datos del empleado por ID
    async function fetchEmpleadoPorId(id) {
        try {
            const res = await fetch(`http://localhost:8080/api/empleados/${id}`);
            if (!res.ok) throw new Error("Empleado no encontrado");
            const empleado = await res.json();
            nombreInput.value = empleado.nombre || '';
            apellidoInput.value = empleado.apellido || '';
            emailInput.value = empleado.email || '';

            // --- CAMBIO: Ocultar mensaje si todo OK ---
            mensajeDiv.style.display = "none";
            empleadoIdInput.classList.remove('is-invalid');

        } catch (error) {
            console.error("Error al obtener empleado:", error);
            limpiarCampos();
            empleadoIdInput.classList.add('is-invalid');
            // --- CAMBIO: Mostrar error ---
            mostrarMensaje("Empleado no encontrado o ID inválido.", "error");
        }
    }

    // Evento cambio de ID
    empleadoIdInput.addEventListener("input", (e) => {
        const id = e.target.value.trim();
        if (id === '') {
            limpiarCampos();
            return;
        }
        if (!isNaN(id)) {
            fetchEmpleadoPorId(id);
        } else {
            limpiarCampos();
            empleadoIdInput.classList.add('is-invalid');
        }
    });

    // Enviar formulario
    form.addEventListener("submit", async (e) => {
        e.preventDefault();

        // --- CAMBIO: Ocultar mensaje anterior ---
        mensajeDiv.style.display = "none";

        const empleadoId = empleadoIdInput.value;
        const descripcion = motivoInput.value;

        if (!nombreInput.value || !apellidoInput.value) {
            // --- CAMBIO: Reemplazo de alert ---
            mostrarMensaje("Por favor, ingresa un ID válido de empleado.", "error");
            return;
        }

        try {
            const res = await fetch(`http://localhost:8080/api/denuncias/empleado/${empleadoId}`, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({ descripcion })
            });
            if (res.ok) {
                // --- CAMBIO: Reemplazo de alert + setTimeout ---
                mostrarMensaje("Denuncia agregada correctamente", "exito");
                setTimeout(() => {
                    window.location.href = "denuncias.html";
                }, 2000); // 2 segundos de espera
            } else {
                // --- CAMBIO: Reemplazo de alert ---
                mostrarMensaje("Error al agregar denuncia", "error");
            }
        } catch (error) {
            console.error("Error al guardar denuncia:", error);
            // --- CAMBIO: Mensaje de error de conexión ---
            mostrarMensaje("No se pudo conectar con el servidor.", "error");
        }
    });

    // Inicialización
    fetchPuestos();

    function limpiarCampos() {
        nombreInput.value = '';
        apellidoInput.value = '';
        emailInput.value = '';
        empleadoIdInput.classList.remove('is-invalid');
    }
</script>
</body>
</html>