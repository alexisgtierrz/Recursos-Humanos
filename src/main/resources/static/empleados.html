<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Empleados - RRHH</title>
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>
<header>
    <p>SISTEMA DE RRHH</p>
    <nav>
        <a href="empleados.html">Gesti√≥n de Empleados</a>
        <a href="denuncias.html">Denuncias</a>

        <div class="logout">
            <button class="btn btn-red">Cerrar Sesi√≥n</button>
        </div>
    </nav>


</header>

<main>
    <div class="search-box">
        <input type="text" id="searchInput" placeholder="Buscar empleado..." class="search-bar">
        <div class="bottom-right">
            <a href="agregar_empleado.html" class="btn" id="btnAgregar">Agregar Empleado</a>
        </div>
    </div>

    <div id="mensaje-feedback" style="display: none;"></div>

    <div id="confirmarModal" class="modal" style="display: none;">
        <div class="modal-contenido">
            <h4>Confirmar Eliminaci√≥n</h4>
            <p>¬øSeguro que quieres eliminar este empleado?</p>
            <div class="modal-acciones">
                <button id="btnConfirmarEliminar" class="btn btn-red">Eliminar</button>
                <button id="btnCancelarEliminar" class="btn">Cancelar</button>
            </div>
        </div>
    </div> <div id="empleados-list"></div>

</main>



<footer>
    <p>Todos los Derechos Reservados 2025 &copy;</p>
</footer>

<script>
    let empleadosGlobal = []; // üîπ Guardamos todos los empleados aqu√≠

    // --- NUEVO: Obtenemos referencias a los nuevos elementos ---
    const mensajeDiv = document.getElementById("mensaje-feedback");
    const modal = document.getElementById("confirmarModal");
    const btnConfirmarEliminar = document.getElementById("btnConfirmarEliminar");
    const btnCancelarEliminar = document.getElementById("btnCancelarEliminar");

    // --- NUEVO: Funci√≥n para mostrar mensajes ---
    function mostrarMensaje(texto, tipo = "exito") {
        mensajeDiv.textContent = texto;
        mensajeDiv.className = tipo === "exito" ? "mensaje-exito" : "mensaje-error";
        mensajeDiv.style.display = "block";

        // Ocultar solo mensajes de √©xito despu√©s de 3 seg
        if (tipo === "exito") {
            setTimeout(() => {
                mensajeDiv.style.display = "none";
            }, 3000);
        }
    }

    // Funci√≥n para traer empleados desde el backend
    function fetchEmpleados() {
        fetch("http://localhost:8080/api/empleados", {
            headers: {
                "Authorization": "Basic " + btoa("admin:Password123") // reemplaza por tus credenciales
            }
        })
            .then(res => res.json())
            .then(data => {
                empleadosGlobal = data; // guardamos los empleados
                renderEmpleados(data); // renderizamos
            })
            .catch(err => {
                console.error("Error cargando empleados:", err);
                mostrarMensaje("Error al cargar la lista de empleados.", "error");
            });
    }

    // Funci√≥n para renderizar empleados en la p√°gina
    function renderEmpleados(empleados) {
        const contenedor = document.getElementById("empleados-list");
        contenedor.innerHTML = ""; // limpiar lista previa

        if (empleados.length === 0) {
            contenedor.innerHTML = "<p>No se encontraron empleados.</p>";
            return;
        }

        empleados.forEach(emp => {
            const card = document.createElement("div");
            card.classList.add("card");

            card.innerHTML = `
                <div>
                    <strong>${emp.nombre} ${emp.apellido}</strong><br>
                    DNI: ${emp.dni}<br>
                    Fecha Nacimiento: ${emp.fechaNacimiento}<br>
                    Email: ${emp.email}<br>
                    Tel√©fono: ${emp.telefono}<br>
                    Puesto: ${emp.puesto ? emp.puesto.nombre : "Sin asignar"}<br>
                    Salario: $${emp.salario}
                </div>
                <div class="actions">
                    <button class="editar" data-id="${emp.id}">‚úèÔ∏è</button>
                    <button class="eliminar" data-id="${emp.id}">üóëÔ∏è</button>
                </div>
            `;

            contenedor.appendChild(card);
        });

        // Eventos editar (sin cambios)
        document.querySelectorAll(".editar").forEach(btn => {
            btn.addEventListener("click", function() {
                const id = this.getAttribute("data-id");
                sessionStorage.setItem("editarEmpleadoId", id);
                window.location.href = "agregar_empleado.html";
            });
        });

        // --- CAMBIO: Eventos eliminar (ahora solo abre el modal) ---
        document.querySelectorAll(".eliminar").forEach(btn => {
            btn.addEventListener("click", function() {
                const id = this.getAttribute("data-id");
                // Guardamos el ID en el bot√≥n de confirmar del modal
                btnConfirmarEliminar.dataset.idParaEliminar = id;
                modal.style.display = "flex"; // Muestra el modal
            });
        });
    }

    // --- NUEVO: Listeners para el Modal (se a√±aden una sola vez) ---

    // Al hacer clic en "Cancelar" en el modal
    btnCancelarEliminar.addEventListener("click", () => {
        modal.style.display = "none";
    });

    // Al hacer clic en "Eliminar" en el modal
    btnConfirmarEliminar.addEventListener("click", async function() {
        const id = this.dataset.idParaEliminar; // Obtenemos el ID guardado
        modal.style.display = "none"; // Ocultamos el modal

        // Ocultamos cualquier mensaje viejo
        mensajeDiv.style.display = "none";

        try {
            const response = await fetch(`http://localhost:8080/api/empleados/${id}`, {
                method: "DELETE",
                headers: {
                    "Authorization": "Basic " + btoa("admin:Password123")
                }
            });
            if (response.ok) {
                // --- REEMPLAZO DE ALERT (√âXITO) ---
                mostrarMensaje("Empleado eliminado correctamente ‚úÖ");
                fetchEmpleados(); // Recarga la lista
            } else {
                // --- REEMPLAZO DE ALERT (ERROR) ---
                mostrarMensaje("Error al eliminar el empleado", "error");
            }
        } catch (error) {
            console.error(error);
            // --- REEMPLAZO DE ALERT (CONEXI√ìN) ---
            mostrarMensaje("No se pudo conectar con el servidor.", "error");
        }
    });


    // üîπ B√∫squeda en vivo (sin cambios)
    document.getElementById("searchInput").addEventListener("input", function() {
        const filtro = this.value.toLowerCase();
        const filtrados = empleadosGlobal.filter(emp =>
            `${emp.nombre} ${emp.apellido}`.toLowerCase().includes(filtro)
        );
        renderEmpleados(filtrados);
    });

    // Cerrar sesi√≥n (sin cambios)
    document.querySelector(".logout .btn-red").addEventListener("click", function() {
        localStorage.clear();
        sessionStorage.clear();
        window.location.href = "index.html";
    });

    // üîπ Limpiar sessionStorage si presiono "Agregar Empleado" (sin cambios)
    const btnAgregar = document.getElementById("btnAgregar");
    if (btnAgregar) {
        btnAgregar.addEventListener("click", () => {
            sessionStorage.removeItem("editarEmpleadoId");
        });
    }

    // Llamada inicial
    fetchEmpleados();
</script>
</body>
</html>